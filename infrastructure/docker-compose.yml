version: "3.8"

services:
  lgtm:
    image: grafana/otel-lgtm:latest
    container_name: lgtm
    ports:
      - "3000:3000"
      - "4317:4317"
      - "4318:4318"
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin

  redis:
    image: redis:alpine
    container_name: message-broker
    ports:
      - "6379:6379"

  # ============================================
  # [NEW] Kafka with KRaft (Zookeeper 없음!)
  # ============================================
  kafka:
    image: confluentinc/cp-kafka:latest
    container_name: kafka
    ports:
      - "9092:9092"
      - "9093:9093"
    environment:
      # ============================================
      # KRaft 모드 설정 (핵심!)
      # ============================================
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: 'broker,controller'  # 브로커 + 컨트롤러 역할 동시 수행
      KAFKA_CONTROLLER_QUORUM_VOTERS: '1@kafka:9094'  # 컨트롤러 투표자 목록
      KAFKA_CONTROLLER_LISTENER_NAMES: 'CONTROLLER'
      
      # ============================================
      # Listener 설정
      # ============================================
      KAFKA_LISTENERS: 'PLAINTEXT://0.0.0.0:9093,PLAINTEXT_HOST://0.0.0.0:9092,CONTROLLER://0.0.0.0:9094'
      KAFKA_ADVERTISED_LISTENERS: 'PLAINTEXT://kafka:9093,PLAINTEXT_HOST://localhost:9092'
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: 'PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT,CONTROLLER:PLAINTEXT'
      KAFKA_INTER_BROKER_LISTENER_NAME: 'PLAINTEXT'
      
      # ============================================
      # 로그 디렉토리 (KRaft는 별도 디렉토리 필요)
      # ============================================
      KAFKA_LOG_DIRS: '/tmp/kraft-combined-logs'
      
      # ============================================
      # Cluster ID (KRaft 필수!)
      # 아래 명령어로 생성: kafka-storage random-uuid
      # 또는 아무 UUID나 사용 가능
      # ============================================
      CLUSTER_ID: 'MkU3OEVBNTcwNTJENDM2Qk'  # 예시 UUID
      
      # ============================================
      # Topic 설정
      # ============================================
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_DELETE_TOPIC_ENABLE: "true"
      
      # ============================================
      # 복제 설정 (단일 노드이므로 1)
      # ============================================
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      
      # 로그 보존 설정
      KAFKA_LOG_RETENTION_HOURS: 168
      KAFKA_LOG_SEGMENT_BYTES: 1073741824
    
    # ============================================
    # Healthcheck
    # ============================================
    healthcheck:
      test: ["CMD-SHELL", "kafka-broker-api-versions --bootstrap-server localhost:9092 || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 40s
    
    # ============================================
    # [선택사항] 볼륨 마운트
    # ============================================
    # volumes:
    #   - kafka-data:/tmp/kraft-combined-logs

  # ============================================
  # Kafka UI
  # ============================================
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    depends_on:
      kafka:
        condition: service_healthy
    ports:
      - "8089:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9093
      # ============================================
      # [변경] Zookeeper 설정 제거!
      # KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181  # ← 삭제
      # ============================================
      DYNAMIC_CONFIG_ENABLED: "true"
    restart: unless-stopped

# 볼륨 정의 (선택사항)
# volumes:
#   kafka-data:
